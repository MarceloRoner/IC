<!DOCTYPE html>
<html lang="pt-br" data-bs-theme="light">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>M√©todo de Newton‚ÄëRaphson</title>

    <!-- Bootstrap 5.3.3 -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-iuXRGyOX5lD+W9GE3X2lLgqJKEM2mOckLfU+piL2r5xQAYfqs9pZ9hyvXtZ4iBvI"
      crossorigin="anonymous"
    />

    <link
      rel="icon"
      href="https://cdn-icons-png.flaticon.com/512/616/616490.png"
      type="image/png"
    />

    <!-- Estilos customizados -->
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}" />
    <style>
      /* Caso n√£o queira arquivo separado, descomente e remova o link acima. */
      /*
      body {
        background: #f8f9fa;
      }
      .card {
        border-radius: 1rem;
        padding: 2rem;
      }
      textarea {
        resize: none;
      }
      img {
        max-width: 100%;
        height: auto;
        border-radius: 0.5rem;
        margin-top: 1rem;
      }
      */
    </style>
  </head>
  <body>
    <div class="container-lg py-4">
      <div class="mx-auto card shadow-lg" style="max-width: 720px">
        <!-- Header -->
        <div class="d-flex justify-content-between align-items-center mb-3">
          <h1 class="h3 m-0 text-center flex-grow-1">
            M√©todo de Newton‚ÄëRaphson
          </h1>
          <!-- Dark‚Äëmode toggle -->
          <button
            id="themeToggle"
            type="button"
            class="btn btn-outline-secondary btn-sm ms-2"
            aria-label="Alternar tema"
          >
            üåì
          </button>
        </div>

        <!-- Instru√ß√µes -->
        <div class="alert alert-info">
          <h5 class="mb-2">Como usar?</h5>
          <ul class="mb-0">
            <li>Digite a fun√ß√£o em <strong>f(x)</strong>, ex.: <code>x**2 - 2</code></li>
            <li>Informe o <strong>chute inicial</strong> (ex.: 1.5)</li>
            <li>Defina <strong>toler√¢ncia</strong> (ex.: 1e‚Äë6) e <strong>m√°x. itera√ß√µes</strong></li>
            <li>Marque "Detalhes" se quiser o log completo</li>
            <li>Escolha os gr√°ficos desejados</li>
          </ul>
        </div>

        <!-- Formul√°rio principal -->
        <form method="POST" class="needs-validation" novalidate>
          <!-- Hist√≥rico (sessionStorage) -->
          <div class="mb-3">
            <label for="history" class="form-label">Hist√≥rico r√°pido:</label>
            <select id="history" class="form-select"></select>
          </div>

          <div class="mb-3">
            <label for="equation" class="form-label" id="help-equation">Equa√ß√£o f(x):</label>
            <input
              type="text"
              class="form-control"
              id="equation"
              name="equation"
              placeholder="Ex: x**3 - x - 2"
              value="x**3 - x - 2"
              required
              aria-describedby="help-equation"
              autofocus
            />
            <div class="invalid-feedback">Informe uma equa√ß√£o v√°lida.</div>
          </div>

          <div class="row g-3 mb-3">
            <div class="col-sm">
              <label for="x0" class="form-label">Chute inicial (x‚ÇÄ):</label>
              <input
                type="number"
                step="any"
                class="form-control"
                id="x0"
                name="x0"
                value="1.5"
                required
              />
            </div>
            <div class="col-sm">
              <label for="tol" class="form-label">Toler√¢ncia:</label>
              <input
                type="number"
                step="any"
                class="form-control"
                id="tol"
                name="tol"
                value="1e-6"
                required
              />
            </div>
            <div class="col-sm">
              <label for="max_iter" class="form-label">M√°x. itera√ß√µes:</label>
              <input
                type="number"
                class="form-control"
                id="max_iter"
                name="max_iter"
                value="100"
                required
              />
            </div>
          </div>

          <div class="form-check mb-3">
            <input
              class="form-check-input"
              type="checkbox"
              id="verbose"
              name="verbose"
            />
            <label class="form-check-label" for="verbose">Detalhes das itera√ß√µes</label>
          </div>

          <hr />
          <h6>Gr√°ficos:</h6>
          <div class="row row-cols-2 g-2 mb-3">
            <div class="form-check col">
              <input
                class="form-check-input"
                type="checkbox"
                id="plot_fx"
                name="plot_fx"
                checked
              />
              <label class="form-check-label" for="plot_fx">f(x)</label>
            </div>
            <div class="form-check col">
              <input
                class="form-check-input"
                type="checkbox"
                id="plot_iter"
                name="plot_iter"
                checked
              />
              <label class="form-check-label" for="plot_iter">x‚Çô</label>
            </div>
            <div class="form-check col">
              <input
                class="form-check-input"
                type="checkbox"
                id="plot_fxn"
                name="plot_fxn"
              />
              <label class="form-check-label" for="plot_fxn">f(x‚Çô)</label>
            </div>
            <div class="form-check col">
              <input
                class="form-check-input"
                type="checkbox"
                id="plot_error"
                name="plot_error"
                checked
              />
              <label class="form-check-label" for="plot_error">Erro |x‚Çô‚Çä‚ÇÅ¬†‚àí¬†x‚Çô|</label>
            </div>
          </div>

          <div class="d-grid mb-3">
            <button type="submit" class="btn btn-success" id="submitBtn">
              Calcular
            </button>
          </div>
        </form>

        <!-- Resultado -->
        {% if result %}
        <div class="alert alert-primary" role="alert">
          <strong>Resultado:</strong> {{ result }}
        </div>
        <!-- === BOT√ÉO + FORMUL√ÅRIO PARA PDF ======================= -->
<form id="pdfForm" action="/pdf" method="POST" target="_blank" class="d-none">
    <input type="hidden" name="equation" value="{{ equation }}">
    <input type="hidden" name="result"   value="{{ result }}">
    <input type="hidden" name="log"      value="{{ log }}">
    {% for p in plots %}
      <input type="hidden" name="plots" value="{{ p }}">
    {% endfor %}
  </form>
  
  <div class="d-grid mb-3">
    <button type="button"
            class="btn btn-outline-primary"
            onclick="document.getElementById('pdfForm').submit()">
      Baixar PDF
    </button>
  </div>
  <!-- ====================================================== -->
  {% endif %}

        <!-- Log em accordion -->
        {% if log %}
        <div class="accordion mb-3" id="logAccordion">
          <div class="accordion-item">
            <h2 class="accordion-header" id="headingLog">
              <button
                class="accordion-button collapsed"
                type="button"
                data-bs-toggle="collapse"
                data-bs-target="#collapseLog"
                aria-expanded="false"
                aria-controls="collapseLog"
              >
                Detalhes das itera√ß√µes
              </button>
            </h2>
            <div
              id="collapseLog"
              class="accordion-collapse collapse"
              aria-labelledby="headingLog"
              data-bs-parent="#logAccordion"
            >
              <div class="accordion-body">
                <pre class="mb-0">{{ log }}</pre>
              </div>
            </div>
          </div>
        </div>
        {% endif %}

        <!-- Gr√°ficos -->
        {% if plots %}
        <div class="text-center">
          <h5 class="mb-3">Visualiza√ß√µes</h5>
          {% for plot in plots %}
          <img
            src="data:image/png;base64,{{ plot }}"
            class="img-fluid mb-3"
            loading="lazy"
            alt="Gr√°fico gerado pelo m√©todo de Newton‚ÄëRaphson"
          />
          {% endfor %}
        </div>
        {% endif %}
      </div>
    </div>

    <!-- Bootstrap JS bundle -->
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-ZH5xSzmM4tYqkhtPcHb9iQXjhtxGkqMoFeoJCsOjXf17JBB4hvP9JJw2OmWibXw5"
      crossorigin="anonymous"
    ></script>

    <!-- Tema escuro e hist√≥rico (sessionStorage) -->
    <script>
      // ----------------- tema claro/escuro -----------------
      const toggle = document.getElementById("themeToggle");
      const root = document.documentElement;
      const storedTheme = localStorage.getItem("theme") || "light";
      root.dataset.bsTheme = storedTheme;
      toggle.addEventListener("click", () => {
        root.dataset.bsTheme = root.dataset.bsTheme === "light" ? "dark" : "light";
        localStorage.setItem("theme", root.dataset.bsTheme);
      });

      // ----------------- hist√≥rico -----------------
      const HISTORY_KEY = "newton-history";
      const historySel = document.getElementById("history");
      const form = document.querySelector("form");

      function refreshHistory() {
        const hist = JSON.parse(sessionStorage.getItem(HISTORY_KEY) || "[]");
        historySel.innerHTML = "";
        const optDefault = new Option("‚Äî selecione ‚Äî", "");
        historySel.add(optDefault);
        hist.forEach((h) => {
          const label = `${h.eq} (x‚ÇÄ=${h.x0})`;
          const opt = new Option(label, h.eq);
          opt.dataset.x0 = h.x0;
          historySel.add(opt);
        });
      }

      refreshHistory();

      historySel.addEventListener("change", function () {
        if (this.value) {
          document.getElementById("equation").value = this.value;
          document.getElementById("x0").value = this.selectedOptions[0].dataset.x0;
        }
      });

      form.addEventListener("submit", () => {
        const hist = JSON.parse(sessionStorage.getItem(HISTORY_KEY) || "[]");
        hist.unshift({ eq: form.equation.value, x0: form.x0.value, ts: Date.now() });
        sessionStorage.setItem(HISTORY_KEY, JSON.stringify(hist.slice(0, 5)));
      });

      // ----------------- valida√ß√£o bootstrap -----------------
      (() => {
        const forms = document.querySelectorAll(".needs-validation");
        Array.from(forms).forEach((f) => {
          f.addEventListener(
            "submit",
            (event) => {
              if (!f.checkValidity()) {
                event.preventDefault();
                event.stopPropagation();
              }
              f.classList.add("was-validated");
            },
            false
          );
        });
      })();
    </script>
  </body>
</html>
